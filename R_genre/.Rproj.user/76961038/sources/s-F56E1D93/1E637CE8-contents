#### Sraping_Script_Seance 1

#objectifs: d?couvrir la structure d'une page web,
#aspirer le contenu d'une premi?re page web
#identifier les obstacles qu'il faudra savoir contourner
#La page pour s'exercer: https://www.palaisdetokyo.com/fr/evenement/futur-ancien-fugitif


### 0. Pr?requis ####

#0.1. TRavailler quelque part
setwd("C:/Users/Brianne/Documents/Documents/Doctorat Sciences Po/Cours donn?s/ENS 2021 22/Master QESS")
#chemin ? adapter bien ?videmment

#0.2. Installation des packages (? n'appliquer qu'une seule fois)

#install.packages(rvest)
#le package que nous allons utiliser pour scraper

#install.packages(tidyverse)
#"Le terme tidyverse est une contraction de tidy (qu'on pourrait traduire par "bien rang?") 
#et de universe. Il s'agit en fait d'une collection d'extensions con?ues pour travailler ensemble
#et bas?es sur une philosophie commune. (...) n des objectifs de ces extensions est de fournir 
#des fonctions avec une syntaxe coh?rente, qui fonctionnent bien ensemble, 
#et qui retournent des r?sultats pr?visibles
#Cette commande va en fait installer plusieurs extensions qui constituent le "coeur" du tidyverse, ? savoir :
#ggplot2 (visualisation)
#dplyr (manipulation des donn?es)
#tidyr (remise en forme des donn?es)
#purrr (programmation)
#readr (importation de donn?es)
#tibble (tableaux de donn?es)
#forcats (variables qualitatives)
#stringr (cha?nes de caract?res)" 
#pour en savoir plus: https://juba.github.io/tidyverse/06-tidyverse.html


#0.3. Chargement des packages
library(rvest)
library(tidyverse)
library(stringr)

#0.4. Un petit outil tr?s utile pour aider la s?lection sur une page web: https://selectorgadget.com/
#installer l'extension chrome et travailler depuis chrome

#0.5. Un petit outil utile: %>% 
# "pipe" pour appliquer une fonction ? un objet
#Ctrl + Shift + M


### 1. Exploration de la page web ####

#On commence par cr?er un objet avec le contenu de la page
page_expo <- read_html ("https://www.palaisdetokyo.com/fr/evenement/futur-ancien-fugitif")

#Ouvrir la page dans Chrome: https://www.palaisdetokyo.com/fr/evenement/futur-ancien-fugitif

#clic droit: Inspecter
#on cherche dans le code source ? identifier un point de rep?re pour trouver 
#o? sont les ?l?ments qui nous int?ressent.

#C'est ici qu'intervient le SelectorGadget
#s'il n'appara?t pas automatiquement en haut ? droite de votre ?cran,
# cliquer sur l'ic?ne en forme de pi?ce de puzzle "extension"
#et s?lectionner la punaise de Selector gadget pour qu'il reste apparent.
#vous pouvez ensuite cliquer sur la petite loupe pour l'activer, 
#puis sur les ?l?ments qui vous int?ressent.
#En cas de doute sur son fonctionnement: https://selectorgadget.com/

#Nous sommes d?sormais capable de rep?rer dans le code source les ?l?ments
#que nous souhaitons aspirer.


### 2. Construction de la base de donn?es - vide! ####

#Faisons un pas en arri?re et prenons un peu de recul.
#Quelles sont les variables primaires que nous souhaitons construire ? partir de cette page?

#On construit un dataframe vide, avec ces variables primaires en colonnes.
expo <- data.frame(titre = as.character(page_expo %>% html_nodes("h1") %>%
                   html_text()),
                   texte = NA,
                   artistes = NA,
                   commissaires = NA,
                   dates = NA)


View(expo) #on v?rifie que ce tableau nous convient bien.
#ici j'ai rempli la premi?re case en aspirant des donn?es,
#on revient dans la suite du script sur le pourquoi et le comment.


### 3. Aspiration des donn?es dans la base ####

# 3.1. Explication de l'aspiration du contenu du titre
#le marqueur donn? par le gadget est "h1"
#html_nodes trouve des tags HTML (nodes) en utilisant des s?lecteurs CSS ou des epxressions XPath.
#html_text2() simule ce ? quoi le texte ressemble dans le browser.
#il est conseill? d'utiliser plut?t html_text2(), plus lent mais plus performent que html_text


#on aspire cette information
page_expo %>%
  html_nodes("h1") %>%
  html_text2()

#3.2. Les autres variables

#3.2.1. le texte:
#on aspire cette information
text <- page_expo %>%
  html_nodes("h1+ p, p:nth-child(4), p:nth-child(6), p:nth-child(8)") %>%
  html_text2()

#text est une cha?ne de charact?re, un vecteur compos? de 5 ?l?ments
#on ne veut qu'un seul ?l?ment
text_uni <- paste(text,collapse="")

#on peut le ranger dans le tableau
expo$texte <- text_uni
expo$texte

#3.2.2. artistes
artist <- page_expo %>%
  html_nodes("h4") %>%
  html_text2()
#? nouveau, il s'agit d'un vecteur de 2 ?l?ments
artistes_uni <- paste(artist,collapse="")

expo$artistes <- artistes_uni

#3.2.3. commissaires
expo$commissaires <- page_expo %>%
  html_nodes("h3+ p") %>%
  html_text2() 

#3.2.4. dates
expo$dates <- page_expo %>%
  html_nodes(".event-date-text h2") %>%
  html_text2() 



####4. Exporter les donn?es ####
write.csv2 (expo, "expo_11oct.csv") 



###5. Un bon script avec tout en une seule fois! ####
page_expo <- read_html ("https://www.palaisdetokyo.com/fr/evenement/futur-ancien-fugitif")

expo_1 <- data.frame(titre = as.character(page_expo %>% html_nodes("h1") %>%
                                          html_text2()),
                   texte = as.character(paste(page_expo %>%
                                                html_nodes("h1+ p, p:nth-child(4), p:nth-child(6), p:nth-child(8)") %>%
                                                html_text2(),collapse="")),
                   artistes = as.character(paste(page_expo %>%
                                                   html_nodes("h4") %>%
                                                   html_text2(),collapse="")),
                   commissaires = as.character(page_expo %>%
                                                 html_nodes("h3+ p") %>%
                                                 html_text2()),
                   dates = as.character(page_expo %>%
                                          html_nodes(".event-date-text h2") %>%
                                          html_text2()))



#6. Est-ce que ?a marche sur les autres pages?
#? tester!!
#on verra ?a la semaine prochaine

# Pour aujourd'hui, je vous laisse transposer ce script ? une autre page web. 
